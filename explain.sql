EXPLAIN (analyze, costs, verbose, buffers, format json) SELECT f.name, f.points FROM flags f LEFT JOIN (SELECT team_id, flag_id FROM v_solves vs LEFT JOIN teams t ON vs.team_id=t.id WHERE t.name='t1') AS ts ON ts.flag_id=f.id WHERE ts.flag_id IS NULL AND f.visible AND f.enabled AND f.solvable UNION SELECT f.name, (f.points - cp)::int points FROM flags f LEFT JOIN (SELECT team_id, flag_id FROM v_solves vs LEFT JOIN teams t ON vs.team_id=t.id WHERE t.name='t1') AS ts ON ts.flag_id=f.id LEFT JOIN (SELECT parent, SUM(points) cp from solved('t1') GROUP BY parent) AS sc ON sc.parent=f.id WHERE ts.flag_id IS NULL AND f.visible AND f.enabled AND NOT f.solvable
